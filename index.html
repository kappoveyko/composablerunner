<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Espresso Dino — Canvas Runner</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, Arial;
    }
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1b1a18;
    }
    #gameWrap {
      width: 900px;
      max-width: 95%;
      background: linear-gradient(180deg, #2a231f 0%, #1b1715 100%);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      position: relative;
    }
    canvas {
      display: block;
      background: linear-gradient(180deg, #e9d7c8 0%, #c9b39a 100%);
      border-radius: 8px;
    }
    .hud {
      display: flex;
      justify-content: space-between;
      color: #fff;
      margin-bottom: 8px;
    }
    .hud .brand {
      font-weight: 700;
      color: #ffb86b;
    }
    .hint {
      color: #e7e0d9;
      font-size: 13px;
      margin-top: 8px;
      margin-bottom: 48px; /* Отступ для иконок */
    }
    .sound-toggle {
      position: absolute;
      bottom: 8px;
      right: 12px;
      width: 37px;
      height: 37px;
      cursor: pointer;
      border: 1px solid #f3c28d; /* Золотая рамка */
      border-radius: 4px;
      background: #fceded; /* Белый фон */
      transition: border-color 0.2s, background 0.2s; /* Плавный переход */
    }
    .sound-toggle:hover {
      border-color: #999999; /* Тусклый серый при ховере */
      background: #cccccc; /* Серый фон при ховере */
    }
    .author {
      position: absolute;
      bottom: 6px;
      left: 14px;
      display: flex;
      align-items: center;
      color: #ffffff7a;
      font-size: 13px;
      text-decoration: none;
      cursor: pointer;
    }
    .author img {
      width: 20px;
      height: 20px;
      border: 1px solid #ebccac67;
      border-radius: 4px;
      background: #6d6969;
      margin-right: 5px;
      margin-left: 5px;
      transition: border-color 0.2s, background 0.2s;
    }
    .author:hover img {
      border-color: #999999;
      background: #cccccc;
    }
    .author:hover {
      text-decoration: underline;
    }
    /* Для подредактирования позиции/стиля авторства:
       - Измените bottom/left для .author
       - Измените font-size, color для текста
       - Измените width/height, border, border-radius для .author img
    */
  </style>
</head>
<body>
<div id="gameWrap">
  <div class="hud">
    <div class="brand">Composable Runner</div>
    <div id="score" style="font-family:monospace">SCORE: 0</div>
  </div>
  <canvas id="game" width="900" height="220"></canvas>
  <div class="hint">Press <strong>Space</strong> or <strong>Click</strong> to jump, <strong>Escape</strong> to pause.</div>
  <img id="soundToggle" class="sound-toggle" src="img/soundon.png" alt="Sound Toggle">
  <a href="https://x.com/hollywilly114" class="author" target="_blank">
    <span>Made by </span>
    <img src="img/twitter.jpg" alt="Twitter Logo">
    <span>hollywilly114</span>
  </a>
</div>

<script>
// === Настройки канваса ===
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width;
const H = canvas.height;

// === Загрузка картинок ===
let playerImg1 = new Image();
playerImg1.src = "img/mainchar.png"; // Персонаж (стоя)
let playerImg2 = new Image();
playerImg2.src = "img/charwalking.png"; // Персонаж (ходьба)
let pillarImg = new Image();
pillarImg.src = "img/pillar.png"; // Столбики
let flyerImg1 = new Image();
flyerImg1.src = "img/staticbird.png"; // Птичка (статичная)
let flyerImg2 = new Image();
flyerImg2.src = "img/flybird.png"; // Птичка (крылья)
let cloudImg1 = new Image();
cloudImg1.src = "img/cloud1.png"; // Тучка 1
let cloudImg2 = new Image();
cloudImg2.src = "img/cloud2.png"; // Тучка 2
let cloudImg3 = new Image();
cloudImg3.src = "img/cloud3.png"; // Тучка 3
let sunImg = new Image();
sunImg.src = "img/sun.png"; // Солнце
let soundOnImg = new Image();
soundOnImg.src = "img/soundon.png"; // Иконка звука включен
let soundOffImg = new Image();
soundOffImg.src = "img/soundoff.png"; // Иконка звука выключен
let twitterImg = new Image();
twitterImg.src = "img/twitter.jpg"; // Логотип Twitter

// === Загрузка звуков ===
let jumpSound = new Audio("snd/jump.wav"); // Звук прыжка
let loseSound = new Audio("snd/gameover.wav"); // Звук проигрыша
let music = new Audio("snd/sound.mp3"); // Фоновая музыка

// Настройка громкости (0.0 - тишина, 1.0 - максимум)
jumpSound.volume = 0.5; // Громкость прыжка — 50%
loseSound.volume = 0.8; // Громкость проигрыша — 80%
music.volume = 0; // Начальная громкость 0, включается при прыжке
music.loop = true; // Зацикливание музыки

// Флаги загрузки изображений
let playerImg1Loaded = false;
let playerImg2Loaded = false;
let pillarImgLoaded = false;
let flyerImg1Loaded = false;
let flyerImg2Loaded = false;
let cloudImg1Loaded = false;
let cloudImg2Loaded = false;
let cloudImg3Loaded = false;
let sunImgLoaded = false;
let soundOnImgLoaded = false;
let soundOffImgLoaded = false;
let twitterImgLoaded = false;

// Проверка загрузки изображений
playerImg1.onload = () => { playerImg1Loaded = true; tryStart(); };
playerImg2.onload = () => { playerImg2Loaded = true; tryStart(); };
pillarImg.onload = () => { pillarImgLoaded = true; tryStart(); };
flyerImg1.onload = () => { flyerImg1Loaded = true; tryStart(); };
flyerImg2.onload = () => { flyerImg2Loaded = true; tryStart(); };
cloudImg1.onload = () => { cloudImg1Loaded = true; tryStart(); };
cloudImg2.onload = () => { cloudImg2Loaded = true; tryStart(); };
cloudImg3.onload = () => { cloudImg3Loaded = true; tryStart(); };
sunImg.onload = () => { sunImgLoaded = true; tryStart(); };
soundOnImg.onload = () => { soundOnImgLoaded = true; tryStart(); };
soundOffImg.onload = () => { soundOffImgLoaded = true; tryStart(); };
twitterImg.onload = () => { twitterImgLoaded = true; tryStart(); };
playerImg1.onerror = () => { console.error('Ошибка загрузки mainchar.png'); playerImg1Loaded = true; tryStart(); };
playerImg2.onerror = () => { console.error('Ошибка загрузки charwalking.png'); playerImg2Loaded = true; tryStart(); };
pillarImg.onerror = () => { console.error('Ошибка загрузки pillar.png'); pillarImgLoaded = true; tryStart(); };
flyerImg1.onerror = () => { console.error('Ошибка загрузки staticbird.png'); flyerImg1Loaded = true; tryStart(); };
flyerImg2.onerror = () => { console.error('Ошибка загрузки flybird.png'); flyerImg2Loaded = true; tryStart(); };
cloudImg1.onerror = () => { console.error('Ошибка загрузки cloud1.png'); cloudImg1Loaded = true; tryStart(); };
cloudImg2.onerror = () => { console.error('Ошибка загрузки cloud2.png'); cloudImg2Loaded = true; tryStart(); };
cloudImg3.onerror = () => { console.error('Ошибка загрузки cloud3.png'); cloudImg3Loaded = true; tryStart(); };
sunImg.onerror = () => { console.error('Ошибка загрузки sun.png'); sunImgLoaded = true; tryStart(); };
soundOnImg.onerror = () => { console.error('Ошибка загрузки soundon.png'); soundOnImgLoaded = true; tryStart(); };
soundOffImg.onerror = () => { console.error('Ошибка загрузки soundoff.png'); soundOffImgLoaded = true; tryStart(); };
twitterImg.onerror = () => { console.error('Ошибка загрузки twitter.jpg'); twitterImgLoaded = true; tryStart(); };

// Проверка загрузки звуков (логи для отладки)
jumpSound.onloadeddata = () => { console.log('Звук прыжка загружен'); };
loseSound.onloadeddata = () => { console.log('Звук проигрыша загружен'); };
music.onloadeddata = () => { console.log('Фоновая музыка загружена'); };
jumpSound.onerror = () => { console.error('Ошибка загрузки jump.wav'); };
loseSound.onerror = () => { console.error('Ошибка загрузки lose.wav'); };
music.onerror = () => { console.error('Ошибка загрузки sound.mp3'); };

function tryStart() {
  if (playerImg1Loaded && playerImg2Loaded && pillarImgLoaded && flyerImg1Loaded && flyerImg2Loaded && 
      cloudImg1Loaded && cloudImg2Loaded && cloudImg3Loaded && sunImgLoaded && soundOnImgLoaded && soundOffImgLoaded && twitterImgLoaded) {
    console.log('Все изображения загружены или обработаны, запуск цикла');
    requestAnimationFrame(loop);
  } else {
    console.log('Ожидание загрузки:', { playerImg1Loaded, playerImg2Loaded, pillarImgLoaded, flyerImg1Loaded, flyerImg2Loaded, 
                                       cloudImg1Loaded, cloudImg2Loaded, cloudImg3Loaded, sunImgLoaded, soundOnImgLoaded, soundOffImgLoaded, twitterImgLoaded });
  }
}

// === Основные игровые переменные ===
let gameState = 'START'; // Начальное состояние — ожидание старта
let score = 0;
let scoreAccumulator = 0;
let speed = 6;
let baseGravity = 0.8;
let lastTime = performance.now();
let spawnTimer = 0;
let cloudSpawnTimer = 0;
let countdownTimer = 0;
let customPillars = [];
let flyers = [];
let clouds = [];
let isMusicPlaying = true; // Флаг: музыка включена
let hasStarted = false; // Флаг: игра началась (после первого прыжка)

// Параметры солнца
const sun = {
  x: -36,
  y: -36,
  w: 120,
  h: 120
};

// Пороги появления врагов
const FLYER_THRESHOLD = 400;

// Цветовая палитра
const COLORS = {
  espressoDark: '#2b1e18',
  crema: '#f2d1b3',
  bean: '#5a3b2b',
  accent: '#ffb86b',
  ground: '#3b2f2a',
  white: '#ffffff'
};

// Параметры игрока
const player = {
  x: 70,
  y: H - 92,
  w: 55,
  h: 80,
  hitboxOffsetX: 4,
  hitboxOffsetY: 4,
  hitboxW: 33,
  hitboxH: 75,
  vy: 0,
  onGround: true,
  jumpStrength: -14,
  ducking: false,
  frame: 0,
  frameTimer: 0
};

// Параметры кнопки паузы
const pauseButton = {
  x: W / 2 - 100,
  y: H / 2 + 20,
  w: 200,
  h: 40,
  text: 'Continue',
  color: COLORS.white,
  hoverColor: COLORS.bean,
  isHovered: false
};

// Параметры тучек
const cloudConfig = {
  minY: 20,
  maxY: 60,
  w: 100,
  h: 65,
  speedMultiplier: 0.3,
  interval: 3000
};

// Массив изображений тучек
const cloudImages = [cloudImg1, cloudImg2, cloudImg3];

// === Управление звуком ===
const soundToggle = document.getElementById('soundToggle');
soundToggle.addEventListener('click', () => {
  isMusicPlaying = !isMusicPlaying;
  soundToggle.src = isMusicPlaying ? "img/soundon.png" : "img/soundoff.png";
  music.volume = isMusicPlaying ? 0.3 : 0; // Громкость 0.3 или 0
  console.log('Звук переключен:', isMusicPlaying ? 'включен (volume: 0.3)' : 'выключен (volume: 0)');
});

// === Обработка фокуса окна ===
window.addEventListener('blur', () => {
  if (gameState === 'RUN') {
    gameState = 'PAUSED';
    if (isMusicPlaying) {
      music.volume = 0; // Громкость 0 при паузе
      console.log('Фоновая музыка приглушена (потеря фокуса)');
    }
    console.log('Пауза: потеря фокуса');
  }
});

// === Сброс игры ===
function resetGame() {
  gameState = 'DEAD'; // После смерти сразу DEAD
  score = 0;
  scoreAccumulator = 0;
  speed = 6;
  customPillars = [];
  flyers = [];
  clouds = [];
  player.y = H - 92;
  player.vy = 0;
  player.onGround = true;
  lastTime = performance.now();
  spawnTimer = 0;
  cloudSpawnTimer = 0;
  hasStarted = false;
  if (isMusicPlaying) {
    music.volume = 0; // Громкость 0 при рестарте
    music.currentTime = 0; // Сбрасываем в начало
    console.log('Фоновая музыка сброшена (рестарт)');
  }
  soundToggle.src = isMusicPlaying ? "img/soundon.png" : "img/soundoff.png";
  console.log('Игра сброшена, score:', score);
}

// === Управление ===
window.addEventListener('keydown', (e) => {
  if (e.code === 'Space') {
    if (gameState === 'START') {
      gameState = 'RUN';
      console.log('Игра начата (пробел)');
    }
    if (gameState === 'DEAD') {
      gameState = 'RUN'; // Прямой переход в RUN
      score = 0;
      scoreAccumulator = 0;
      speed = 6;
      customPillars = [];
      flyers = [];
      clouds = [];
      player.y = H - 92;
      player.vy = 0;
      player.onGround = true;
      spawnTimer = 0;
      cloudSpawnTimer = 0;
      hasStarted = false;
      if (isMusicPlaying) {
        music.volume = 0;
        music.currentTime = 0;
        console.log('Фоновая музыка сброшена (рестарт через пробел)');
      }
      console.log('Рестарт через пробел, score:', score);
    }
    if (gameState === 'RUN') jump();
  } else if (e.code === 'ArrowDown') {
    player.ducking = true;
  } else if (e.code === 'Escape' && gameState === 'RUN') {
    gameState = 'PAUSED';
    if (isMusicPlaying) {
      music.volume = 0; // Громкость 0 при паузе
      console.log('Фоновая музыка приглушена (пауза)');
    }
    console.log('Пауза: нажат Escape');
  }
});
window.addEventListener('keyup', (e) => { if (e.code === 'ArrowDown') player.ducking = false; });
canvas.addEventListener('mousedown', (e) => {
  if (gameState === 'START') {
    gameState = 'RUN';
    console.log('Игра начата (клик)');
  }
  if (gameState === 'DEAD') {
    gameState = 'RUN';
    score = 0;
    scoreAccumulator = 0;
    speed = 6;
    customPillars = [];
    flyers = [];
    clouds = [];
    player.y = H - 92;
    player.vy = 0;
    player.onGround = true;
    spawnTimer = 0;
    cloudSpawnTimer = 0;
    hasStarted = false;
    if (isMusicPlaying) {
      music.volume = 0;
      music.currentTime = 0;
      console.log('Фоновая музыка сброшена (рестарт через клик)');
    }
    console.log('Рестарт через клик, score:', score);
  }
  if (gameState === 'RUN') jump();
  if (gameState === 'PAUSED') {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    if (
      mouseX >= pauseButton.x && mouseX <= pauseButton.x + pauseButton.w &&
      mouseY >= pauseButton.y && mouseY <= pauseButton.y + pauseButton.h
    ) {
      gameState = 'COUNTDOWN';
      countdownTimer = 3000;
      console.log('Выход из паузы, старт отсчета');
    }
  }
});
canvas.addEventListener('mousemove', (e) => {
  if (gameState === 'PAUSED') {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    pauseButton.isHovered = (
      mouseX >= pauseButton.x && mouseX <= pauseButton.x + pauseButton.w &&
      mouseY >= pauseButton.y && mouseY <= pauseButton.y + pauseButton.h
    );
  }
});

// === Прыжок ===
function jump() {
  if (player.onGround) {
    player.vy = player.jumpStrength;
    player.onGround = false;
    // Проигрывание звука прыжка
    jumpSound.play().then(() => {
      console.log('Звук прыжка воспроизведен');
    }).catch((err) => {
      console.error('Ошибка воспроизведения звука прыжка:', err);
    });
    // Старт фоновой музыки после первого прыжка
    if (!hasStarted) {
      hasStarted = true;
      if (isMusicPlaying) {
        music.volume = 0.3; // Включаем громкость
        music.play().then(() => {
          console.log('Фоновая музыка воспроизведена (первый прыжок)');
        }).catch((err) => {
          console.error('Ошибка воспроизведения фоновой музыки:', err);
        });
      }
    }
    console.log('Прыжок, vy:', player.vy);
  }
}

// === Спавн кастомных столбиков ===
function spawnCustomPillar() {
  const type = Math.floor(Math.random() * 3); // 0: большой, 1: средние, 2: маленькие
  const gap = 8;

  if (type === 0) {
    const pillar = {
      x: W + 20,
      y: H - 80,
      w: 60,
      h: 75,
      img: pillarImg,
      hitboxOffsetX: 11,
      hitboxOffsetY: 10,
      hitboxW: 33,
      hitboxH: 60,
      speed: speed
    };
    customPillars.push(pillar);
  } else if (type === 1) {
    const count = Math.floor(Math.random() * 2) + 1; // 1 или 2
    for (let i = 0; i < count; i++) {
      const pillar = {
        x: W + 20 + i * (45 + gap),
        y: H - 76,
        w: 45,
        h: 70,
        img: pillarImg,
        hitboxOffsetX: 9,
        hitboxOffsetY: 10,
        hitboxW: 27,
        hitboxH: 60,
        speed: speed
      };
      customPillars.push(pillar);
    }
  } else {
    const count = Math.floor(Math.random() * 3) + 1; // 1, 2 или 3
    for (let i = 0; i < count; i++) {
      const pillar = {
        x: W + 20 + i * (32 + gap),
        y: H - 69,
        w: 37,
        h: 60,
        img: pillarImg,
        hitboxOffsetX: 7,
        hitboxOffsetY: 10,
        hitboxW: 19,
        hitboxH: 60,
        speed: speed
      };
      customPillars.push(pillar);
    }
  }
}

// === Спавн птичек ===
function spawnFlyer() {
  const heightType = Math.floor(Math.random() * 2); // 0: низкая, 1: высокая
  let y;
  if (heightType === 0) y = H - 80; // Низкая, легко перепрыгнуть
  else y = H - 160; // Высокая, не перепрыгнуть
  flyers.push({
    x: W + 20,
    y: y,
    w: 50,
    h: 37,
    hitboxOffsetX: 4,
    hitboxOffsetY: 2,
    hitboxW: 42,
    hitboxH: 33,
    frame: 0,
    frameTimer: 0,
    bob: Math.random() * Math.PI * 2
  });
}

// === Спавн тучек ===
function spawnCloud() {
  const imgIndex = Math.floor(Math.random() * 3); // Случайный выбор изображения (0, 1 или 2)
  clouds.push({
    x: W + 20,
    y: Math.random() * (cloudConfig.maxY - cloudConfig.minY) + cloudConfig.minY,
    w: cloudConfig.w,
    h: cloudConfig.h,
    img: cloudImages[imgIndex]
  });
  console.log('Спавн тучки, y:', clouds[clouds.length - 1].y, 'img:', imgIndex + 1);
}

// === Проверка столкновений ===
function rectsCollide(a, b) {
  return !(a.x + a.w < b.x || a.x > b.x + b.w || a.y + a.h < b.y || a.y > b.y + b.h);
}

// === Отрисовка солнца ===
function drawSun() {
  ctx.drawImage(sunImg, sun.x, sun.y, sun.w, sun.h);
}

// === Отрисовка земли ===
function drawGround() {
  ctx.fillStyle = COLORS.ground;
  ctx.fillRect(0, H - 20, W, 20);
  for (let i = 0; i < 10; i++) {
    ctx.fillStyle = 'rgba(255,184,107,0.08)';
    ctx.fillRect((i * 120 + (score % 120)) % W, H - 22, 80, 4);
  }
}

// === Отрисовка игрока ===
function drawPlayer() {
  let img = player.frame === 0 ? playerImg1 : playerImg2;
  ctx.drawImage(img, player.x, player.y, player.w, player.h);
  console.log('Отрисовка игрока, x:', player.x, 'y:', player.y);
}

// === Отрисовка кастомного столбика ===
function drawCustomPillar(p) {
  ctx.drawImage(p.img, p.x, p.y, p.w, p.h);
}

// === Отрисовка птички с анимацией ===
function drawFlyer(f) {
  let img = f.frame === 0 ? flyerImg1 : flyerImg2;
  ctx.drawImage(img, f.x, f.y + Math.sin((score / 40) + f.bob) * 6, f.w, f.h);
}

// === Отрисовка тучки ===
function drawCloud(c) {
  ctx.drawImage(c.img, c.x, c.y, c.w, c.h);
}

// === Отрисовка начального экрана ===
function drawStartScreen() {
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.fillRect(0, 0, W, H);
  ctx.fillStyle = COLORS.crema;
  ctx.font = '22px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('PRESS SPACE OR CLICK TO START', W / 2, H / 2);
}

// === Отрисовка паузы ===
function drawPauseScreen() {
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.fillRect(0, 0, W, H);
  ctx.fillStyle = COLORS.crema;
  ctx.font = '22px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('PAUSED', W / 2, H / 2 - 20);

  ctx.fillStyle = pauseButton.isHovered ? pauseButton.hoverColor : pauseButton.color;
  ctx.fillRect(pauseButton.x, pauseButton.y, pauseButton.w, pauseButton.h);
  ctx.fillStyle = COLORS.espressoDark;
  ctx.font = '18px monospace';
  ctx.fillText(pauseButton.text, W / 2, pauseButton.y + 28);
}

// === Отрисовка отсчета ===
function drawCountdown() {
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.fillRect(0, 0, W, H);
  ctx.fillStyle = COLORS.crema;
  ctx.font = '40px monospace';
  ctx.textAlign = 'center';
  const countdown = Math.ceil(countdownTimer / 1000);
  ctx.fillText(countdown.toString(), W / 2, H / 2);
}

// === Логика обновления игры ===
function update(dt) {
  if (gameState === 'START' || gameState === 'DEAD' || gameState === 'PAUSED') return;

  if (gameState === 'COUNTDOWN') {
    countdownTimer -= dt;
    if (countdownTimer <= 0) {
      gameState = 'RUN';
      lastTime = performance.now();
      if (isMusicPlaying && hasStarted) {
        music.volume = 0.3; // Восстанавливаем громкость после паузы
        console.log('Фоновая музыка возобновлена (после отсчета)');
      }
      console.log('Отсчет завершен, игра возобновлена');
    }
    return;
  }

  // Ограничение dt
  dt = Math.min(dt, 100);
  dt = Math.max(dt, 1);

  // Отладка
  console.log('update: dt=', dt, 'score=', score, 'speed=', speed, 'player.y=', player.y, 'player.vy=', player.vy, 'gameState=', gameState);

  // Очки (~20/сек)
  scoreAccumulator += 0.333;
  const scoreIncrement = Math.floor(scoreAccumulator);
  if (scoreIncrement >= 1) {
    score += scoreIncrement;
    scoreAccumulator -= scoreIncrement;
    document.getElementById('score').innerText = 'SCORE: ' + score;
  }

  // Увеличение скорости
  if (score % 200 === 0 && score > 0) {
    speed = 6 + Math.floor(score / 200);
    console.log('Скорость увеличена:', speed);
  }

  // Спавн врагов
  spawnTimer += dt;
  const pillarInterval = Math.max(800, 1200 - speed * 50);
  if (spawnTimer > pillarInterval) {
    spawnTimer = 0;
    // Столбики
    if (Math.random() > 0.2) {
      spawnCustomPillar();
      console.log('Спавн столбиков, score:', score);
    }
    // Птички
    if (score >= FLYER_THRESHOLD && Math.random() < 0.15) {
      spawnFlyer();
      console.log('Спавн flyer, score:', score);
    }
  }

  // Спавн тучек
  cloudSpawnTimer += dt;
  if (cloudSpawnTimer > cloudConfig.interval) {
    spawnCloud();
    cloudSpawnTimer = 0;
  }

  // Физика игрока
  player.vy += baseGravity;
  player.y += player.vy;
  if (player.y >= H - 92) {
    player.y = H - 92;
    player.vy = 0;
    player.onGround = true;
    console.log('Игрок на земле, y:', player.y);
  }

  // Анимация игрока
  if (player.onGround) {
    player.frameTimer += dt;
    if (player.frameTimer > 200) {
      player.frame = (player.frame + 1) % 2;
      player.frameTimer = 0;
    }
  } else {
    player.frame = 0;
  }

  // Анимация птичек
  for (const f of flyers) {
    f.frameTimer += dt;
    if (f.frameTimer > 200) {
      f.frame = (f.frame + 1) % 2;
      f.frameTimer = 0;
    }
  }

  // Движение тучек
  for (let i = clouds.length - 1; i >= 0; i--) {
    const c = clouds[i];
    c.x -= speed * cloudConfig.speedMultiplier;
    if (c.x + c.w < -40) clouds.splice(i, 1);
  }

  const playerHitbox = {
    x: player.x + player.hitboxOffsetX,
    y: player.y + player.hitboxOffsetY,
    w: player.hitboxW,
    h: player.hitboxH
  };

  // Движение и проверка столбиков
  for (let i = customPillars.length - 1; i >= 0; i--) {
    const p = customPillars[i];
    p.x -= speed;
    if (p.x + p.w < -40) customPillars.splice(i, 1);
    const pillarHitbox = {
      x: p.x + p.hitboxOffsetX,
      y: p.y + p.hitboxOffsetY,
      w: p.hitboxW,
      h: p.hitboxH
    };
    if (rectsCollide(playerHitbox, pillarHitbox)) {
      gameState = 'DEAD';
      loseSound.play().then(() => {
        console.log('Звук проигрыша воспроизведен');
      }).catch((err) => {
        console.error('Ошибка воспроизведения звука проигрыша:', err);
      });
      if (isMusicPlaying) {
        music.volume = 0; // Громкость 0 при смерти
        console.log('Фоновая музыка приглушена (смерть)');
      }
      console.log('Столкновение со столбиком, gameState: DEAD');
    }
  }

  // Движение и проверка птичек
  for (let i = flyers.length - 1; i >= 0; i--) {
    const f = flyers[i];
    f.x -= speed * 1.2;
    if (f.x + f.w < -40) flyers.splice(i, 1);
    const fbox = {
      x: f.x + f.hitboxOffsetX,
      y: f.y + f.hitboxOffsetY + Math.sin((score / 40) + f.bob) * 6,
      w: f.hitboxW,
      h: f.hitboxH
    };
    if (rectsCollide(playerHitbox, fbox)) {
      gameState = 'DEAD';
      loseSound.play().then(() => {
        console.log('Звук проигрыша воспроизведен');
      }).catch((err) => {
        console.error('Ошибка воспроизведения звука проигрыша:', err);
      });
      if (isMusicPlaying) {
        music.volume = 0; // Громкость 0 при смерти
        console.log('Фоновая музыка приглушена (смерть)');
      }
      console.log('Столкновение с птичкой, gameState: DEAD');
    }
  }
}

// === Отрисовка кадра ===
function render() {
  ctx.clearRect(0, 0, W, H);

  // Фон
  const g = ctx.createLinearGradient(0, 0, 0, H);
  g.addColorStop(0, '#f6e7d9');
  g.addColorStop(1, '#e3cab0');
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, W, H - 20);

  // Отрисовка солнца (на заднем плане)
  drawSun();

  // Отрисовка тучек (после солнца)
  for (const c of clouds) drawCloud(c);

  drawGround();
  for (const p of customPillars) drawCustomPillar(p);
  for (const f of flyers) drawFlyer(f);
  drawPlayer();

  if (gameState === 'START') drawStartScreen();
  if (gameState === 'PAUSED') drawPauseScreen();
  if (gameState === 'COUNTDOWN') drawCountdown();
  if (gameState === 'DEAD') {
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(0, 0, W, H);
    ctx.fillStyle = COLORS.crema;
    ctx.font = '22px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('GAME OVER — CLICK TO RESTART', W / 2, H / 2);
  }
}

// === Главный цикл ===
function loop(ts) {
  let dt = ts - lastTime;
  lastTime = ts;

  dt = Math.min(dt, 100);
  dt = Math.max(dt, 1);

  console.log('loop: ts=', ts, 'dt=', dt, 'gameState=', gameState);
  update(dt);
  render();
  requestAnimationFrame(loop);
}

// Запуск
gameState = 'START'; // Устанавливаем START только при загрузке
</script>
</body>

</html>
